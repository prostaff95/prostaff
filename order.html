<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PROSTAFF — Buyurtma (Ishchi)</title>
  <style>
    :root{--bg:#0b1220;--card:#111a2e;--text:#e7eef7;--muted:#93a4bd;--primary:#2d6bff;--primary2:#4aa3ff;}
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;background:var(--bg);color:var(--text)}
    .wrap{max-width:720px;margin:0 auto;padding:16px}
    .top{display:flex;align-items:center;gap:12px;margin:8px 0 16px}
    .top a{color:#cfe1ff;text-decoration:none;font-size:14px}
    h1{margin:0 0 12px;font-size:22px}
    .card{background:var(--card);border:1px solid #1e2b4a;border-radius:14px;padding:16px;box-shadow:0 6px 24px rgba(0,0,0,.35)}
    label{display:block;font-size:13px;color:var(--muted);margin:10px 0 6px}
    input,textarea,select,button{width:100%;border-radius:10px;border:1px solid #24345a;background:#0f1730;color:var(--text);padding:12px;font-size:16px;outline:none}
    textarea{resize:vertical;min-height:90px}
    .row{display:flex;gap:10px}
    .row > *{flex:1}
    .btn{background:linear-gradient(135deg,var(--primary),var(--primary2));border:none;font-weight:600;cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .hint{font-size:12px;color:var(--muted)}
    .ok{background:#0e3a15;border:1px solid #1e6a2a;color:#b8f5c3}
    .err{background:#3a1212;border:1px solid #692323;color:#ffc9c9}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top"><a href="./workers.html">← Orqaga</a></div>
    <h1>Ishchi uchun buyurtma</h1>
    <p class="hint">Iltimos, ma’lumotlarni to‘ldiring. “Lokatsiyani aniqlash” tugmasi sizning hozirgi GPS manzilingizdan Google Xarita havolasini qo‘yib beradi.</p>

    <form id="orderForm" class="card">
      <div class="row">
        <div>
          <label>Ismingiz</label>
          <input name="name" type="text" placeholder="Masalan: Diyor" required />
        </div>
        <div>
          <label>Telefon</label>
          <input name="phone" type="tel" placeholder="+998 90 123 45 67" required />
        </div>
      </div>

      <label>Ishchi</label>
      <input name="worker" type="text" placeholder="Ishchi nomi (avtomatik to‘lishi mumkin)" />

      <div class="row">
        <div>
          <label>Shahar</label>
          <input name="city" type="text" placeholder="Masalan: Toshkent" />
        </div>
        <div>
          <label>Sana va vaqt</label>
          <input name="datetime" type="datetime-local" required />
        </div>
      </div>

      <label>Manzil</label>
      <input name="address" type="text" placeholder="Ko‘cha, uy, mo‘ljal" required />

      <label>Izoh</label>
      <textarea name="note" placeholder="Qisqacha izoh… (masalan, 2 xonali uy, 4 soat)"></textarea>

      <label>Lokatsiya (Google Maps URL)</label>
      <div class="row">
        <input name="location" type="url" placeholder="https://maps.google.com/?q=..." />
        <button type="button" id="pickLocation">Lokatsiyani aniqlash</button>
      </div>

      <div style="height:10px"></div>
      <button class="btn" type="submit">Buyurtma berish</button>

      <div id="msg" style="margin-top:10px;display:none" class="ok"></div>
    </form>
  </div>

  <script>
    // ======= Telegram sozlamalari (SIZNIKI) =======
    const BOT_TOKEN = '7967067936:AAHJ1cavttlapzs7B9jJkc9unPE-LNYbVZU';
    const CHAT_ID   = '7692677210';
    const API_URL   = `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`;

    // URL’dan ?worker=... ni olib formaga qo‘yish
    (function prefillFromURL(){
      const p = new URLSearchParams(location.search);
      const w = p.get('worker');
      if (w) document.querySelector('input[name="worker"]').value = w;
    })();

    // Lokatsiya tugmasi
    const pickBtn = document.getElementById('pickLocation');
    if (pickBtn) {
      pickBtn.addEventListener('click', () => {
        if (!navigator.geolocation) {
          return alert('Geolokatsiya qurilmada mavjud emas.');
        }
        navigator.geolocation.getCurrentPosition(
          pos => {
            const { latitude, longitude } = pos.coords;
            const url = `https://maps.google.com/?q=${latitude},${longitude}`;
            document.querySelector('input[name="location"]').value = url;
          },
          err => alert('Lokatsiya olinmadi: ' + err.message),
          { enableHighAccuracy:true, timeout:10000 }
        );
      });
    }

    // Formani yuborish -> Telegram
    const form = document.getElementById('orderForm');
    const msgBox = document.getElementById('msg');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(form);
      const d  = Object.fromEntries(fd.entries());

      const lines = [
        '🆕 <b>Yangi buyurtma (Ishchi)</b>',
        d.worker   ? `👷 Ishchi: ${d.worker}` : '',
        d.name     ? `👤 Mijoz: ${d.name}` : '',
        d.phone    ? `📞 Tel: ${d.phone}` : '',
        d.city     ? `🌆 Shahar: ${d.city}` : '',
        d.address  ? `📍 Manzil: ${d.address}` : '',
        d.datetime ? `🗓 Sana/soat: ${d.datetime}` : '',
        d.note     ? `📝 Izoh: ${d.note}` : '',
        d.location ? `📎 Lokatsiya: ${d.location}` : '',
        `⏱ ${new Date().toLocaleString('uz-UZ')}`
      ].filter(Boolean).join('\n');

      try {
        const res = await fetch(API_URL, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ chat_id: CHAT_ID, text: lines, parse_mode: 'HTML' })
        });
        if (!res.ok) throw new Error('Telegram API xatosi');

        msgBox.className = 'ok';
        msgBox.textContent = '✅ Buyurtma yuborildi! Tez orada operator bog‘lanadi.';
        msgBox.style.display = 'block';
        form.reset();
      } catch (err) {
        console.error(err);
        msgBox.className = 'err';
        msgBox.textContent = '❌ Xatolik! Iltimos, keyinroq yana urinib ko‘ring.';
        msgBox.style.display = 'block';
      }
    });
  </script>
</body>
</html>
